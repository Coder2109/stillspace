---
// GlobalPlayer.astro - Persistent bottom player bar for cross-page playback
---

<div id="global-player" data-astro-transition-persist="musicspace-player" class="fixed bottom-0 left-0 right-0 z-50 transform translate-y-full transition-transform duration-300" data-visible="false">
  <div class="bg-white/95 dark:bg-gray-900/95 backdrop-blur-lg border-t border-gray-200 dark:border-gray-700 shadow-lg">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center gap-4">
        <!-- Track Info -->
        <div class="flex items-center gap-3 min-w-0 flex-1">
          <div id="player-artwork" class="w-12 h-12 rounded-lg bg-gradient-to-br from-accent-one to-accent-two flex items-center justify-center flex-shrink-0 dark:from-accent-one dark:to-accent-two">
            <svg class="w-6 h-6 text-white dark:text-black" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p id="player-title" class="font-medium text-sm truncate text-gray-900 dark:text-white">No track selected</p>
            <p id="player-artist" class="text-xs text-gray-500 dark:text-gray-400 truncate">Select a track to play</p>
          </div>
        </div>
        
        <!-- Center Controls -->
        <div class="flex items-center gap-2">
          <button id="player-prev" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Previous">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
            </svg>
          </button>
          
          <button id="player-toggle" class="p-3 rounded-full bg-gradient-to-r from-accent-one to-accent-two text-white dark:text-black hover:brightness-110 transition-all shadow-lg" title="Play/Pause">
            <svg id="player-play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="player-pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
            </svg>
          </button>
          
          <button id="player-next" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Next">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
            </svg>
          </button>
        </div>
        
        <!-- Progress Bar -->
        <div class="hidden md:flex items-center gap-2 flex-1 max-w-md">
          <span id="player-current-time" class="text-xs text-gray-500 dark:text-gray-400 w-10 text-right">0:00</span>
          <div class="flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden cursor-pointer group" id="player-progress-container">
            <div id="player-progress" class="h-full bg-gradient-to-r from-accent-one to-accent-two rounded-full transition-all" style="width: 0%"></div>
          </div>
          <span id="player-duration" class="text-xs text-gray-500 dark:text-gray-400 w-10">0:00</span>
        </div>
        
        <!-- Right Controls -->
        <div class="flex items-center gap-2 relative">
          <!-- Shuffle Button -->
          <button id="player-shuffle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Shuffle">
            <svg id="shuffle-icon" class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
            </svg>
          </button>
          
          <!-- Repeat Button -->
          <button id="player-repeat" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Repeat">
            <svg id="repeat-icon" class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>
            </svg>
            <svg id="repeat-one-icon" class="w-5 h-5 text-accent-one dark:text-accent-two hidden" fill="currentColor" viewBox="0 0 24 24">
              <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-2v-6h2l-4-4-4 4h2v6h4z"/>
            </svg>
          </button>
          
          <!-- Sleep Timer Button -->
          <button id="player-sleep" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Sleep Timer">
            <svg id="sleep-icon" class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
            </svg>
          </button>
          
          <!-- Sleep Timer Dropdown -->
          <div id="sleep-timer-dropdown" class="absolute bottom-full right-0 mb-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden">
            <div class="p-2">
              <button class="sleep-timer-option w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-minutes="15">15 min</button>
              <button class="sleep-timer-option w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-minutes="30">30 min</button>
              <button class="sleep-timer-option w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-minutes="45">45 min</button>
              <button class="sleep-timer-option w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-minutes="60">60 min</button>
              <hr class="my-1 border-gray-200 dark:border-gray-700">
              <button id="sleep-timer-off" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-red-500 dark:text-red-400">Off</button>
            </div>
          </div>
          
          <!-- Volume Control -->
          <div class="flex items-center gap-2 group">
            <button id="player-volume-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Volume">
              <svg id="volume-icon" class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
              </svg>
              <svg id="volume-mute-icon" class="w-5 h-5 text-gray-700 dark:text-gray-300 hidden" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
              </svg>
            </button>
            <input type="range" id="player-volume" min="0" max="100" value="70" class="w-20 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full cursor-pointer accent-special-dark dark:accent-amber-200">
          </div>
          
          <!-- Close Button -->
          <button id="player-close" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Close player">
            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden audio element -->
<audio id="global-audio" data-astro-transition-persist="musicspace-audio" preload="auto"></audio>

<script>
  import { getAudioEngine } from './AudioEngine.js';

  function initMusicSpacePlayer() {
    if (typeof window === 'undefined') return;
    if (window.__musicspacePlayerInitialized) return;

    const engine = getAudioEngine();
    if (!engine) {
      return;
    }

    // DOM Elements
    const player = document.getElementById('global-player');
    const toggleBtn = document.getElementById('player-toggle');
    const prevBtn = document.getElementById('player-prev');
    const nextBtn = document.getElementById('player-next');
    const closeBtn = document.getElementById('player-close');
    const progressContainer = document.getElementById('player-progress-container');
    const volumeSlider = document.getElementById('player-volume');
    const volumeBtn = document.getElementById('player-volume-btn');
    const shuffleBtn = document.getElementById('player-shuffle');
    const repeatBtn = document.getElementById('player-repeat');
    const sleepBtn = document.getElementById('player-sleep');
    
    // UI elements
    const title = document.getElementById('player-title');
    const artist = document.getElementById('player-artist');
    const playIcon = document.getElementById('player-play-icon');
    const pauseIcon = document.getElementById('player-pause-icon');
    const progress = document.getElementById('player-progress');
    const currentTime = document.getElementById('player-current-time');
    const duration = document.getElementById('player-duration');
    const shuffleIcon = document.getElementById('shuffle-icon');
    const repeatIcon = document.getElementById('repeat-icon');
    const repeatOneIcon = document.getElementById('repeat-one-icon');
    const sleepIcon = document.getElementById('sleep-icon');
    const volumeIcon = document.getElementById('volume-icon');
    const volumeMuteIcon = document.getElementById('volume-mute-icon');

    if (!player) return;

    let previousVolume = 0.7;

    function updateVolumeIcon(volume) {
      if (volume === 0) {
        volumeIcon?.classList.add('hidden');
        volumeMuteIcon?.classList.remove('hidden');
      } else {
        volumeIcon?.classList.remove('hidden');
        volumeMuteIcon?.classList.add('hidden');
      }
    }

    // Update UI based on state
    function updateUI(state) {
      // Show/hide player
      if (state.currentTrack) {
        player.classList.remove('translate-y-full');
        player.dataset.visible = 'true';
      }

      // Update track info
      if (state.currentTrack) {
        title.textContent = state.currentTrack.title || 'Unknown Track';
        artist.textContent = state.currentTrack.artist || 'Unknown Artist';
      }

      // Update play/pause icon
      if (state.isPlaying) {
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
      } else {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      }

      // Update progress
      if (state.duration > 0) {
        const progressPercent = (state.currentTime / state.duration) * 100;
        progress.style.width = `${progressPercent}%`;
        currentTime.textContent = engine.formatTime(state.currentTime);
        duration.textContent = engine.formatTime(state.duration);
      }

      // Update shuffle button
      if (state.shuffle) {
        shuffleIcon.classList.remove('text-gray-400', 'dark:text-gray-500');
        shuffleIcon.classList.add('text-accent-one', 'dark:text-accent-two');
      } else {
        shuffleIcon.classList.remove('text-accent-one', 'dark:text-accent-two');
        shuffleIcon.classList.add('text-gray-400', 'dark:text-gray-500');
      }

      // Update repeat button
      repeatIcon.classList.add('hidden');
      repeatOneIcon.classList.add('hidden');
      if (state.repeat === 'all') {
        repeatIcon.classList.remove('hidden');
        repeatIcon.classList.remove('text-gray-400', 'dark:text-gray-500');
        repeatIcon.classList.add('text-accent-one', 'dark:text-accent-two');
      } else if (state.repeat === 'one') {
        repeatOneIcon.classList.remove('hidden');
        repeatOneIcon.classList.remove('text-gray-400', 'dark:text-gray-500');
        repeatOneIcon.classList.add('text-accent-one', 'dark:text-accent-two');
      } else {
        repeatIcon.classList.remove('hidden');
        repeatIcon.classList.remove('text-accent-one', 'dark:text-accent-two');
        repeatIcon.classList.add('text-gray-400', 'dark:text-gray-500');
      }

      // Update sleep timer icon
      if (state.sleepTimer) {
        sleepIcon.classList.remove('text-gray-400', 'dark:text-gray-500');
        sleepIcon.classList.add('text-accent-one', 'dark:text-accent-two');
      } else {
        sleepIcon.classList.remove('text-accent-one', 'dark:text-accent-two');
        sleepIcon.classList.add('text-gray-400', 'dark:text-gray-500');
      }

      // Update volume
      if (volumeSlider) volumeSlider.value = state.volume * 100;
      updateVolumeIcon(state.volume);
    }

    engine.subscribe(updateUI);
    updateUI(engine.getState());

    toggleBtn?.addEventListener('click', () => engine.toggle());
    prevBtn?.addEventListener('click', () => engine.previous());
    nextBtn?.addEventListener('click', () => engine.next());

    // Shuffle button
    shuffleBtn?.addEventListener('click', () => engine.toggleShuffle());

    // Repeat button
    repeatBtn?.addEventListener('click', () => engine.toggleRepeat());

    progressContainer?.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const state = engine.getState();
      if (state.duration) {
        engine.seek(percent * state.duration);
      }
    });

    volumeSlider?.addEventListener('input', (e) => {
      const volume = parseInt(e.target.value) / 100;
      engine.setVolume(volume);
    });

    volumeBtn?.addEventListener('click', () => {
      const state = engine.getState();
      if (state.volume > 0) {
        previousVolume = state.volume;
        engine.setVolume(0);
      } else {
        engine.setVolume(previousVolume);
      }
    });

    closeBtn?.addEventListener('click', () => {
      engine.stop();
      player.classList.add('translate-y-full');
      player.dataset.visible = 'false';
    });

    // Shuffle button
    shuffleBtn?.addEventListener('click', () => {
      engine.toggleShuffle();
    });

    // Repeat button
    repeatBtn?.addEventListener('click', () => {
      engine.toggleRepeat();
    });

    // Sleep timer button
    sleepBtn?.addEventListener('click', () => {
      const dropdown = document.getElementById('sleep-timer-dropdown');
      dropdown.classList.toggle('hidden');
    });

    // Sleep timer options
    document.querySelectorAll('.sleep-timer-option').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const minutes = parseInt(e.target.dataset.minutes);
        engine.setSleepTimer(minutes);
        document.getElementById('sleep-timer-dropdown').classList.add('hidden');
      });
    });

    // Sleep timer off
    document.getElementById('sleep-timer-off')?.addEventListener('click', () => {
      engine.clearSleepTimer();
      document.getElementById('sleep-timer-dropdown').classList.add('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('sleep-timer-dropdown');
      const sleepBtn = document.getElementById('player-sleep');
      if (!sleepBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (player.dataset.visible !== 'true') return;
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.code) {
        case 'Space':
          e.preventDefault();
          engine.toggle();
          break;
        case 'ArrowLeft':
          if (e.shiftKey) {
            engine.previous();
          } else {
            const state = engine.getState();
            engine.seek(state.currentTime - 10);
          }
          break;
        case 'ArrowRight':
          if (e.shiftKey) {
            engine.next();
          } else {
            const state = engine.getState();
            engine.seek(state.currentTime + 10);
          }
          break;
        case 'ArrowUp':
          e.preventDefault();
          {
            const state = engine.getState();
            engine.setVolume(Math.min(1, state.volume + 0.1));
          }
          break;
        case 'ArrowDown':
          e.preventDefault();
          {
            const state = engine.getState();
            engine.setVolume(Math.max(0, state.volume - 0.1));
          }
          break;
        case 'KeyM':
          {
            const state = engine.getState();
            if (state.volume > 0) {
              previousVolume = state.volume;
              engine.setVolume(0);
            } else {
              engine.setVolume(previousVolume);
            }
          }
          break;
      }
    });

    window.addEventListener('musicspace-show-player', () => {
      player.classList.remove('translate-y-full');
      player.dataset.visible = 'true';
    });

    window.__musicspacePlayerInitialized = true;
  }

  document.addEventListener('astro:page-load', () => {
    initMusicSpacePlayer();
  });

  document.addEventListener('DOMContentLoaded', () => {
    initMusicSpacePlayer();
  });
</script>

<style>
  #player-volume::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(to right, var(--accent-one), var(--accent-two));
    cursor: pointer;
  }
  
  #player-volume::-moz-range-thumb {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(to right, var(--accent-one), var(--accent-two));
    cursor: pointer;
    border: none;
  }
</style>
