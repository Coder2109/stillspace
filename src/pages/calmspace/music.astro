---
import PageLayout from "@/layouts/Base.astro";
import { musicCategories, getSubcategories } from "@/components/music/trackData.js";

const musicSubcategories = getSubcategories('music');
const ambienceSubcategories = getSubcategories('ambience');
---

<PageLayout meta={{ title: "Music - CalmSpace" }}>
	<section class="max-w-5xl mx-auto px-4 py-8 pb-32">

		<!-- Header -->
		<div class="text-center mb-8">
			<h1 class="text-4xl font-bold mb-4">
				<span class="bg-gradient-to-r from-accent-one to-accent-two bg-clip-text text-transparent dark:hidden">Music</span>
				<span class="hidden dark:inline text-amber-200">Music</span>
			</h1>
		</div>
		
		<!-- Category Tabs -->
		<div class="flex justify-center gap-4 mb-8">
			<button 
				id="tab-music" 
				class="px-6 py-3 rounded-full font-medium transition-all bg-gradient-to-r from-accent-one to-accent-two text-white shadow-lg dark:text-black"
				data-tab="music"
			>
				Music
			</button>
			<button 
				id="tab-ambience" 
				class="px-6 py-3 rounded-full font-medium transition-all bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"
				data-tab="ambience"
			>
				Ambience
			</button>
		</div>
		
		<!-- Music Categories -->
		<div id="music-content" class="space-y-8">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				{musicSubcategories.map((subcat) => (
					<div 
						class="category-card bg-gray-50 dark:bg-gray-800 rounded-2xl p-6 cursor-pointer hover:shadow-lg transition-all hover:-translate-y-1 border border-gray-200 dark:border-gray-700"
						data-category="music"
						data-subcategory={subcat.id}
					>
						<div class="flex items-center justify-between gap-4">
							<div>
								<h3 class="text-lg font-semibold text-gray-900 dark:text-white">{subcat.title}</h3>
								<p class="text-sm text-gray-500 dark:text-gray-400">{subcat.tracks.length} track</p>
							</div>
						</div>
					</div>
				))}
			</div>
		</div>
		
		<!-- Ambience Categories -->
		<div id="ambience-content" class="space-y-8 hidden">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				{ambienceSubcategories.map((subcat) => (
					<div 
						class="category-card bg-gray-50 dark:bg-gray-800 rounded-2xl p-6 cursor-pointer hover:shadow-lg transition-all hover:-translate-y-1 border border-gray-200 dark:border-gray-700"
						data-category="ambience"
						data-subcategory={subcat.id}
					>
						<div class="flex items-center justify-between gap-4">
							<div>
								<h3 class="text-lg font-semibold text-gray-900 dark:text-white">{subcat.title}</h3>
								<p class="text-sm text-gray-500 dark:text-gray-400">{subcat.tracks.length} track</p>
							</div>
						</div>
					</div>
				))}
			</div>
		</div>
		
		<!-- Track List Modal -->
		<div id="track-modal" class="fixed inset-0 z-40 hidden">
			<div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-backdrop"></div>
			<div class="absolute inset-4 md:inset-10 bg-white dark:bg-gray-900 rounded-2xl shadow-2xl overflow-hidden flex flex-col">
				<!-- Modal Header -->
				<div class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
					<h2 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white">Category</h2>
					<button id="modal-close" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
						<svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
						</svg>
					</button>
				</div>
				
				<!-- Track List -->
				<div class="flex-1 overflow-y-auto p-6">
					<div id="track-list" class="space-y-2">
						<!-- Tracks will be populated by JavaScript -->
					</div>
				</div>
				
				<!-- Play All Button -->
				<div class="p-4 border-t border-gray-200 dark:border-gray-700">
					<button id="play-all-btn" class="w-full py-3 bg-gradient-to-r from-accent-one to-accent-two text-white dark:text-black rounded-xl font-medium hover:brightness-110 transition-all flex items-center justify-center gap-2">
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
							<path d="M8 5v14l11-7z"/>
						</svg>
						Play All
					</button>
				</div>
			</div>
		</div>
		
		<div class="flex justify-center mt-12">
			<a
				href="/calmspace/breathe/"
				class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-lg bg-gradient-to-r from-accent-one to-accent-two text-white dark:text-black hover:brightness-110 transition-all"
			>
				Try Breathing Exercise
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
				</svg>
			</a>
		</div>

		<!-- Back Button -->
		<div class="flex justify-center mt-6">
			<a href="/calmspace/" class="flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors font-medium text-sm">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
				</svg>
				Back
			</a>
		</div>
	</section>
</PageLayout>

<script>
	import { getAudioEngine } from '@/components/music/AudioEngine.js';
	import { musicCategories } from '@/components/music/trackData.js';
	
	document.addEventListener('astro:page-load', () => {
		const engine = getAudioEngine();
		
		// Tab switching
		const tabMusic = document.getElementById('tab-music');
		const tabAmbience = document.getElementById('tab-ambience');
		const musicContent = document.getElementById('music-content');
		const ambienceContent = document.getElementById('ambience-content');
		
		function switchTab(tab) {
			if (tab === 'music') {
				tabMusic.className = 'px-6 py-3 rounded-full font-medium transition-all bg-gradient-to-r from-accent-one to-accent-two text-white shadow-lg dark:text-black';
				tabAmbience.className = 'px-6 py-3 rounded-full font-medium transition-all bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700';
				musicContent.classList.remove('hidden');
				ambienceContent.classList.add('hidden');
			} else {
				tabAmbience.className = 'px-6 py-3 rounded-full font-medium transition-all bg-gradient-to-r from-accent-one to-accent-two text-white shadow-lg dark:text-black';
				tabMusic.className = 'px-6 py-3 rounded-full font-medium transition-all bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700';
				ambienceContent.classList.remove('hidden');
				musicContent.classList.add('hidden');
			}
		}
		
		tabMusic?.addEventListener('click', () => switchTab('music'));
		tabAmbience?.addEventListener('click', () => switchTab('ambience'));
		
		// Category cards
		const categoryCards = document.querySelectorAll('.category-card');
		
		const modal = document.getElementById('track-modal');
		const modalBackdrop = document.getElementById('modal-backdrop');
		const modalClose = document.getElementById('modal-close');
		const modalTitle = document.getElementById('modal-title');
		const trackList = document.getElementById('track-list');
		const playAllBtn = document.getElementById('play-all-btn');
		
		let currentTracks = [];
		
		function openModal(category, subcategory) {
			const mainCat = musicCategories[category];
			const subCat = mainCat?.subcategories[subcategory];
			if (!subCat) return;
			
			currentTracks = subCat.tracks;
			
			// Update modal content
			modalTitle.textContent = subCat.title;
			
			// Render tracks
			trackList.innerHTML = currentTracks.map((track, index) => `
				<div class="track-item flex items-center gap-4 p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors cursor-pointer group" data-index="${index}">
					<div class="w-10 h-10 rounded-lg bg-gray-200 dark:bg-gray-700 flex items-center justify-center group-hover:bg-gradient-to-r group-hover:from-accent-one group-hover:to-accent-two transition-all">
						<svg class="w-5 h-5 text-gray-500 group-hover:text-white" fill="currentColor" viewBox="0 0 24 24">
							<path d="M8 5v14l11-7z"/>
						</svg>
					</div>
					<div class="flex-1 min-w-0">
						<p class="font-medium text-gray-900 dark:text-white truncate">${track.title}</p>
						<p class="text-sm text-gray-500 dark:text-gray-400 truncate">${track.subcategory}</p>
					</div>
				</div>
			`).join('');
			
			// Add click listeners to tracks
			trackList.querySelectorAll('.track-item').forEach(item => {
				item.addEventListener('click', () => {
					const index = parseInt(item.dataset.index);
					if (engine) {
						engine.playPlaylist(currentTracks, index);
						window.dispatchEvent(new CustomEvent('musicspace-show-player'));
					}
				});
			});
			
			// Show modal
			modal.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
		}
		
		function closeModal() {
			modal.classList.add('hidden');
			document.body.style.overflow = '';
		}
		
		categoryCards.forEach(card => {
			card.addEventListener('click', () => {
				const category = card.dataset.category;
				const subcategory = card.dataset.subcategory;
				openModal(category, subcategory);
			});
		});
		
		modalBackdrop?.addEventListener('click', closeModal);
		modalClose?.addEventListener('click', closeModal);
		
		// Escape key to close modal
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
				closeModal();
			}
		});
		
		// Play All button
		playAllBtn?.addEventListener('click', () => {
			if (engine && currentTracks.length > 0) {
				engine.playPlaylist(currentTracks, 0);
				window.dispatchEvent(new CustomEvent('musicspace-show-player'));
				closeModal();
			}
		});
	});
</script>

<style>
	.category-card {
		animation: fadeInUp 0.3s ease-out;
	}
	
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
