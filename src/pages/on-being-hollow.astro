---
import PageLayout from "@/layouts/Base.astro";

// Import markdown files directly using glob
const chapterFiles = import.meta.glob('/src/content/book/*.md', { eager: true });

// Process chapters
const chapters = Object.entries(chapterFiles).map(([path, module]: [string, any]) => {
  const frontmatter = module.frontmatter || {};
  return {
    path,
    title: frontmatter.title || 'Untitled',
    order: frontmatter.order || 0,
    description: frontmatter.description || '',
    Content: module.Content
  };
}).sort((a, b) => a.order - b.order);
---

<PageLayout meta={{ title: "On Being Hollow" }}>
  <div class="relative max-w-4xl mx-auto p-4">
    <div class="bg-gradient-to-br from-amber-50 to-orange-50 dark:from-gray-900 dark:to-gray-900 rounded-xl shadow-xl overflow-hidden">
      <!-- Book Content -->
      <div class="bg-amber-50 dark:bg-gray-900 m-6 rounded-lg p-8 md:p-10 h-[550px] overflow-y-auto font-serif leading-relaxed prose prose-base prose-slate dark:prose-invert max-w-none">
        {chapters.length > 0 ? (
          chapters.map((chapter, index) => (
            <div 
              class="chapter-section" 
              data-chapter={index}
              style={index === 0 ? '' : 'display: none;'}
            >
              <chapter.Content />
            </div>
          ))
        ) : (
          <div class="text-center p-12">
            <h1 class="text-3xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">On Being Hollow</h1>
            <p class="text-slate-600 dark:text-slate-400">Content is loading... If you see this message, the book chapters may not have loaded correctly.</p>
          </div>
        )}
      </div>
      
      <!-- Navigation -->
      <div class="flex items-center justify-between p-4 md:p-6 bg-white/90 dark:bg-gray-800/90 border-t border-gray-200/10 dark:border-gray-700/10 gap-4">
        <button id="prev-btn" class="relative flex items-center justify-center h-10 px-6 rounded-lg shadow-lg hover:brightness-110 transition-all bg-gradient-to-r from-accent-one to-accent-two disabled:opacity-40 disabled:cursor-not-allowed" disabled>
          <span class="text-bgColor font-semibold text-sm">← Previous</span>
        </button>
        
        <div class="flex-1 text-center">
          <span id="chapter-title" class="block font-semibold text-sm text-slate-700 dark:text-slate-200 mb-2">
            {chapters.length > 0 ? chapters[0].title : 'Loading...'}
          </span>
          <div class="w-full max-w-[200px] h-2 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto overflow-hidden">
            <div id="progress" class="h-full w-1/4 bg-gradient-to-r from-accent-one to-accent-two transition-all"></div>
          </div>
        </div>
        
        <button id="next-btn" class="relative flex items-center justify-center h-10 px-6 rounded-lg shadow-lg hover:brightness-110 transition-all bg-gradient-to-r from-accent-one to-accent-two disabled:opacity-40 disabled:cursor-not-allowed">
          <span class="text-bgColor font-semibold text-sm">Next →</span>
        </button>
      </div>
    </div>
    
    <!-- Back Button -->
    <div class="flex justify-center p-6">
      <a href="/" class="flex items-center gap-2 px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors font-medium text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Home
      </a>
    </div>
    
    <!-- Table of Contents Toggle -->
    <button id="toc-btn" class="absolute top-8 left-8 w-11 h-11 bg-white dark:bg-gray-800 border-none rounded-full text-xl cursor-pointer shadow-lg transition-all hover:scale-105 z-10 text-gray-700 dark:text-gray-300" title="Table of Contents">
      ☰
    </button>
    
    <!-- Table of Contents Panel -->
    <div id="toc-panel" class="absolute top-4 left-4 w-72 max-h-[calc(100%-2rem)] bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden z-20 hidden">
      <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="m-0 text-sm font-semibold text-slate-700 dark:text-slate-200">Contents</h3>
        <button id="close-toc" class="bg-none border-none text-xl cursor-pointer text-gray-500 dark:text-gray-400 p-0 leading-none hover:text-gray-700 dark:hover:text-gray-200">
          ×
        </button>
      </div>
      <div class="p-2 max-h-[400px] overflow-y-auto">
        {chapters.map((chapter, index) => (
          <button 
            class={`flex flex-col w-full p-3 bg-none border-none rounded-lg text-left cursor-pointer transition-all mb-1 ${index === 0 ? 'bg-blue-50 dark:bg-blue-900/20 border-l-3 border-blue-500' : ''} hover:bg-gray-100 dark:hover:bg-gray-700 toc-item`}
            data-index={index}
          >
            <span class="text-sm text-slate-700 dark:text-slate-200">{chapter.title}</span>
          </button>
        ))}
      </div>
    </div>
  </div>
</PageLayout>

<script define:vars={{ totalChapters: chapters.length, chapterTitles: chapters.map(c => ({ order: c.order, title: c.title })) }}>
  function initBookPage() {
    let currentChapter = 0;
    const total = totalChapters;
    const titles = chapterTitles;
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const tocBtn = document.getElementById('toc-btn');
    const closeToc = document.getElementById('close-toc');
    const tocPanel = document.getElementById('toc-panel');
    const chapterTitle = document.getElementById('chapter-title');
    const progress = document.getElementById('progress');
    const sections = document.querySelectorAll('.chapter-section');
    
    function showChapter(index) {
      if (index < 0 || index >= total) return;
      currentChapter = index;
      
      // Show/hide sections
      sections.forEach((section, i) => {
        section.style.display = i === index ? 'block' : 'none';
      });
      
      // Update nav buttons
      if (prevBtn) prevBtn.disabled = index === 0;
      if (nextBtn) nextBtn.disabled = index === total - 1;
      
      // Update title
      if (chapterTitle && titles[index]) {
        chapterTitle.textContent = titles[index].title;
      }
      
      // Update progress
      if (progress) {
        const pct = ((index + 1) / total) * 100;
        progress.style.width = pct + '%';
      }
      
      // Update TOC active
      const tocItems = document.querySelectorAll('.toc-item');
      tocItems.forEach((item, i) => {
        if (i === index) {
          item.classList.add('bg-blue-50', 'dark:bg-blue-900/20', 'border-l-3', 'border-blue-500');
        } else {
          item.classList.remove('bg-blue-50', 'dark:bg-blue-900/20', 'border-l-3', 'border-blue-500');
        }
      });
      
      // Scroll to top
      const bookContent = document.querySelector('.font-serif');
      if (bookContent) bookContent.scrollTop = 0;
      
      // Save progress
      localStorage.setItem('hollowBookProgress', index.toString());
    }
    
    // Button handlers
    if (prevBtn) prevBtn.addEventListener('click', () => showChapter(currentChapter - 1));
    if (nextBtn) nextBtn.addEventListener('click', () => showChapter(currentChapter + 1));
    
    // TOC handlers
    if (tocBtn) tocBtn.addEventListener('click', () => tocPanel && tocPanel.classList.toggle('hidden'));
    if (closeToc) closeToc.addEventListener('click', () => tocPanel && tocPanel.classList.add('hidden'));
    
    // Get TOC items after DOM is ready
    const tocItems = document.querySelectorAll('.toc-item');
    tocItems.forEach((item) => {
      item.addEventListener('click', () => {
        const idx = parseInt(item.getAttribute('data-index') || '0');
        showChapter(idx);
        if (tocPanel) tocPanel.classList.add('hidden');
      });
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') showChapter(currentChapter - 1);
      if (e.key === 'ArrowRight') showChapter(currentChapter + 1);
      if (e.key === 'Escape' && tocPanel) tocPanel.classList.add('hidden');
    });
    
    // Load saved progress
    const saved = localStorage.getItem('hollowBookProgress');
    if (saved) {
      const idx = parseInt(saved);
      if (idx >= 0 && idx < total) {
        showChapter(idx);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', initBookPage);
  document.addEventListener('astro:page-load', initBookPage);
</script>

<style>
  /* Custom overrides for @tailwindcss/typography */
  .prose :global(h1) {
    @apply text-3xl text-center mb-8 font-bold bg-gradient-to-r from-accent-two/85 via-accent-one/85 to-accent-two/85 dark:from-accent-two dark:via-accent-one dark:to-accent-two bg-clip-text text-transparent !important;
  }
  
  .prose :global(.chapter-section[data-chapter="0"] h1 + *) {
    @apply text-center !important;
  }
</style>
